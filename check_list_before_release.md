## 参照

https://zenn.dev/catnose99/articles/547cbf57e5ad28

個人的に「Web サービスの公開前チェックリスト」を作っていたのですが、けっこう育ってきたので公開します。このリストは、過去に自分がミスしたときや、情報収集する中で「明日は我が身…」と思ったときなどに個人的にメモしてきたものをまとめた内容になります。

!
ヌケモレや偏りがあることや、サービスの要件によって当てはまらない項目があることをあらかじめご了承ください。

なお、この記事では各項目の解説はあまり入れていません。2024 年 7 月 10 日の Classmethod Odyssey で少し詳しく話そうと思っているので、よかったら聞きにきてください。オンラインなので無料です。

## セキュリティ

### 認証に関わる Cookie の属性

- HttpOnly 属性が設定されていること
  - XSS の緩和策
- Secure 属性が設定されていること
  - HTTPS 通信でのみ Cookie が送られるように
- SameSite 属性が Lax もしくは Strict になっていること
  - 主に CSRF 対策のため。Lax の場合、GET リクエストで更新処理を行っているエンドポイントがないか合わせて確認
- Domain 属性が適切に設定されていること
- サブドメインにも Cookie が送られる設定の場合、他のサブドメインのサイトに脆弱性があるとそこからインシデントに繋がるリスクを理解しておく
- 例: example.com の Cookie が採用サイトの jobs.example.com にも送られるようになっており、そのサーバーに脆弱性がある等
- 参考: Cookie の Domain 属性は*指定しない*が一番安全

### ユーザーの入力値のバリデーション

- バリデーションがクライアント側だけでなく、サーバーサイド側でも行われていること
- ユーザー入力の URL のバリデーションが適切に行われていること
  - protocol の制限も忘れずに。javascript:のような URL を指定できないようにする
  - 正規表現を使う場合、バイパスできないかチェックする（文頭チェック漏れや、Ruby のマルチラインフラグのバイパスなど）
- 受け取った HTML をそのまま出力する部分において、危険な文字列が渡される可能性が排除されていること
  - element.innerHtml = input や React の dangerousllySetInnerHtml のような部分
  - ユーザーの入力値を表示する際には事前にエスケープやサニタイズを行うこと
- SQL インジェクションが起こりうる SQL 文が存在しないこと
  - 参考: 安全なウェブサイトの作り方 - 1.1 SQL インジェクション
- ユーザーが URL に含まれるハンドルネーム等を指定できる場合、バリデーションが適切におこなわれていること
  - ユーザー指定のハンドルネームがhttps://example.com/◯◯にあてられる場合は要注意
  - アプリケーションで使用しているパスと被りうる文字列は拒否する
  - アンダースコアから始まる文字列は拒否する（ホスティング先のクラウドサービスがリザーブしている場合がある。 例: Google App Engine だと/\_ah はリザーブされている）
  - 数字だけの文字列は拒否する（/404 へのリクエストをフレームワークが自動的に 404 にすることがある。パスの構成によっては問題ない）
  - リザーブドの文字列一覧を設定し、ユーザーが登録できないようにしておく。admin や contact など（参考: reserved-usernames）

### レスポンスヘッダ

- Strict-Transport-Security がレスポンスヘッダに指定されていること
  - ブラウザに指定された期間中、指定されたドメインへの接続は常に HTTP ではなく HTTPS を使用するように指示
    ```
    {
    key: 'Strict-Transport-Security',
    value: 'max-age=31536000; includeSubDomains; preload'
    }
    ```
- 各ページのレスポンスヘッダに X-Frame-Options: "DENY"もしくは X-Frame-Options: "SAMEORIGIN"が付与されていること（追記: CSP の frame-ancestors を設定した方が良いようです）
  - 想定していない他サイト上での iframe 等によるページの埋め込みを防ぐ = クリックジャッキング対策
- X-Content-Type-Options: nosniff が指定されていること
  - 参考: X-Content-Type-Options: nosniff は IE 以外にも必要

### その他セキュリティ

- 退会/メールアドレス変更などの攻撃を特に防ぎたい部分で、直前のログインを必須にしていること
  - XSS やセッションハイジャックが発生したときの緩和策
- ユーザーにより内容が変わるレスポンスが CDN や KVS にキャッシュされていないこと
- オブジェクトストレージのディレクトリページの URL が公開されていないこと
  - 画像の URL から他の画像の URL を辿れないようにする。サービスの仕様によっては問題ないが、設定しておくのが無難
  - 参考: Cloud Storage で一覧ページは非公開にする
- クライアントから渡された URL にリダイレクトする部分で、バリデーションが行われていること（オープンリダイレクト対策）
  - 例: https://example.com/login?redirect_to=https://evil.exampleを踏んだときにhttps://evil.exampleにリダイレクトしないようにする
- 更新・削除の処理において、権限を持たないユーザーや未認証ユーザーがデータを更新できないこと
  - SQL の DELETE や UPDATE 文で WHERE が適切に設定されていること
    - 例: とある User の Product を一括更新するつもりが、全 Product が更新されてしまう等。自分のプロジェクトでは Prisma の updateMany/deleteMany を特定のクエリ以外では使えないように Extensions で設定している。
- ユーザーから渡された文字列をそのままレスポンスヘッダに含めていないこと
  - レスポンスヘッダが改竄される可能性
- サーバーで発生したエラーメッセージをそのままブラウザに表示していないこと
- ファイルのアップロード機能において、ファイル形式やサイズ、ファイル名などのバリデーションが行われていること
- DB の定期的なバックアップが有効になっていること
- オブジェクトストレージのバックアップが有効になっていること
- 利用するクラウドサービスのアカウントで二要素認証が有効になっていること
- （サービスの要件次第で CSP の設定）

### ログイン

- メールアドレスの本人確認が行われていること
  - ID プロバイダから渡されたメールアドレスであっても本人確認ができているか検証すること
- 登録されているメールアドレスの列挙ができないこと
  - ログイン画面やパスワード再設定画面で「このメールアドレスは登録されていません」といったエラーメッセージから第三者が登録されているかどうかを調べられてしまう
  - 例えば Firebase Authentication はこれができてしまう仕様だったが 2023 年に対応された模様
- 複数のログイン方法を提供している場合、同一ユーザーがアカウント登録したときの仕様が決まっており、実装に反映されていること
  - 例: メールアドレス + パスワード認証でアカウント登録したユーザーが、同一メールアドレスの Google アカウントでログインした場合にどうなるか
- メールアドレス変更や、連携アカウントの変更ができること

## メール送信

- ユーザーの入力値がメールに含まれる場合、その入力を悪用してスパムメールが送られないこと
  - 例: ユーザー名やアイテムのタイトルに宣伝やスパム的な内容を含めると、その内容を編集することでスパムにできてしまう等
- ユーザーが特定の操作をしたときに不特定多数に繰り返しメールが送られないこと
  - 例: フォロー機能で 1 万人をフォローすると 1 万人に通知メールが送られる等
- SPF / DKIM / DMARC の設定が完了していること
- バッチ処理でメールを送る場合、連続で処理が呼び出されてしまったときにもメールが重複して送信されないこと
  - AWS や Google Cloud などでは「At least once delivery」だったりする
- メルマガやキャンペーンメールの場合、ログインなしで購読解除ができるようになっていること
- 大人数にキャンペーンメールを送る場合、List-Unsubscribe=One-Click に対応していること
  - Gmail のメール送信者のガイドラインをチェックしておくのが良い

## SEO

- 全ページで title タグが適切に指定されていること
- SEO 上重要になるページで canonical URL の設定がされていること
  - 例: https://example.com/products/fooとhttps://example.com/products/foo?query=barが同一内容であることを検索エンジンが認識できるようにする
- エラー関連のページのステータスコードが 40x もしくは 50x になっている、もしくは noindex になっていること
- 検索結果ページに noindex もしくは canonical URL が設定されていること
  - もしくは<title>タグと<h1>タグの内容に「検索結果: ◯◯」と明確に含めるようにする。でないと、おかしなキーワードが検索結果にインデックスされてしまう可能性がある
  - 例: https://example.com/search?keyword=UNKOのページタイトルが「UNKO」になっていたら「UNKO」が検索結果にインデックスされてしまうかも
- サイト全体に noindex が付与されていないこと
  - 「リリース時に解除しよう」から忘れがち
- トップページなどの検索流入が多くなるであろうページに meta description が設定されていること
  - 個人的にはユーザー生成のページなどでは無理に設定しなくてもいいと思っている派。おかしな meta description が設定されるくらいなら無くていい。
- 動的にパブリックなページが生成される場合、XML サイトマップを作成し、Search Console に登録されていること

## OGP

- 頻繁にシェアされることが想定されるページの OGP の設定が完了していること
  - このあたりを設定しておきたい
    - og:title
    - og:description
    - og:url
    - og:image
    - twitter:card （X のカードの形式）

## 決済機能をつける場合

- どのように会計処理を行うか担当者と確認が取れていること
- 決済に失敗したときに、アプリケーション上のデータと、Stripe 等の決済代行サービス上のデータで不整合が生じないこと
  - 万が一生じた場合には、そのことを検知できるようになっているか
  - 例: Stripe 上で決済が成功したが、DB の更新処理に失敗する等
- 決済を行ったことがあるユーザーが退会しても会計やアプリケーションのロジックに不整合が生じないこと
  - サブスクリプションを契約中のユーザーがサービスを退会（もしくはアカウント凍結）したときに、サブスクリプションが自動キャンセルされること
  - 決済を行ったことがあるユーザーが退会したときの返金有無や日割り計算について利用規約に書かれていること
    - 退会ページにもこのあたりの注意点は書いておくのが良い
  - 解約の導線が用意されていること
  - 領収書が適格請求書の要件を満たしていること（インボイス制度）
    - 適格請求書発行事業者の場合。Stripe なら日本での請求書/インボイスを設定する際のベストプラクティスが参考になる

## アクセシビリティ

- 画像（<img>）の alt 属性が適切に指定されていること
  - alt の指定の仕方は情報バリアフリーポータルサイトが参考になる
- 内部が svg アイコンだけの<button>や<a>の役割がスクリーンリーダーからも認識できるようになっていること
  ```
  <a href="/" aria-label="リンクの役割を示すテキスト">
  <svg aria-hidden="true" ... ></svg>
  </a>
  ```

この 2 つは忘れがちなのでチェックリストに入れました。その他の項目ついては freee アクセシビリティー・ガイドラインが参考になります。

## パフォーマンス

- 余計なモジュールがバンドル JS に含まれていないこと
  - リリース前に bundle-analyzer などで確認するのが良い
- 静的ファイルが CDN にキャッシュされていること
  - Next.js や Nuxt.js などのフレームワークでは大量の js/css ファイルにリクエストが飛ぶが、これらの静的ファイルは CDN から配信したい
- 画像によるレイアウトシフトが起きないこと
  - img 要素に CSS の aspect-ratio もしくは width/height 属性を指定する
- 必要以上に巨大な画像が読み込まれていないこと
  - 例: 幅 400px で小さく表示されている画像のサイズが実は 2MB だった。よく見かける
- SQL のインデックスが適切に貼られていること
  - リリース後データが増えてから対策を行っても良さそう

## 複数環境での動作確認

- スマホやタブレットサイズの画面で表示したときに UI が崩れないこと
  - これめっちゃよく見る
- 各 OS で見たときにフォントがおかしなことになっていないこと
  - font-family が Mac、Windows、iOS、Android、(Linux)など各 OS でも不自然にならない指定になっていること
- （開発環境が Mac の場合）システム環境設定で「スクロールバーを常に表示」にしても問題がないこと
  - スクロールバーが常に表示される設定では、モーダルを開くとき等にガタつきがち。scrollbar-gutter による対応が必要になるかも
- ユーザーが指定したハンドルネームなどの入力値が長いときに見た目が崩れないこと

## その他

- ローカルストレージや http-only でない Cookie 等が 7 日で消えても問題がないこと
  - あまり知られていないが、最近の iOS Safari では ITP の仕様により、ブラウザ上の JavaScript から保存された Cookie やローカルストレージの内容は 7 日以上ユーザーが触らないと自動で削除される（参考）
- サードパーティ Cookie に依存していないこと
  - 参考: サードパーティ Cookie の廃止に向けた準備
- 日本語サイトの場合、<html lang="ja">となっていること
  - フレームワークによってはデフォルトで lang="en"となっていることがあるので注意
- サーバーエラーが発生したときにエラーの内容が通知される or 検知できるようになっていること
- 404 ページや 50x 系ページが悪くない感じになっていること
  - 404 の場合はトップページ等へのリンク等、次のアクションへの導線が表示されていること
- ファビコンが設定されていること
- apple-touch-icon が設置されていること
- Google Analytics などアクセス解析ツールを導入していること（必要なら）
- クローズドチャットなどのサービスを提供する場合、電気通信事業者の申請をしていること（参考）
- サービス名が他言語でおかしな意味でないこと
  - ChatGPT とかに聞くか、WordSense とかを使うのが良い
